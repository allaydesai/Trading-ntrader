{% extends "base.html" %}

{% block title %}Backtest Details - NTrader{% endblock %}

{% block nav %}
{% include "partials/nav.html" %}
{% endblock %}

{% block breadcrumbs %}
<nav class="flex text-sm text-slate-400 mb-4">
    {% for crumb in view.breadcrumbs %}
    {% if not loop.last %}
    <a href="{{ crumb.url }}" class="hover:text-slate-200">{{ crumb.label }}</a>
    <span class="mx-2">/</span>
    {% else %}
    <span class="text-slate-200">{{ crumb.label }}</span>
    {% endif %}
    {% endfor %}
</nav>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header Section -->
    <div class="bg-slate-900 rounded-lg border border-slate-700 p-6">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-2xl font-semibold mb-2">
                    Run Details: {{ view.run_id_short }}
                </h1>
                <p class="text-lg text-slate-300 mb-1">
                    Strategy: {{ view.strategy_name }}
                </p>
                <p class="text-sm text-slate-400">
                    Executed: {{ view.execution_time.strftime('%Y-%m-%d %H:%M:%S') }} |
                    Duration: {{ view.duration_formatted }}
                </p>
            </div>
            <div>
                {% if view.is_successful %}
                <span class="bg-green-600/20 text-green-400 px-3 py-1 rounded-full text-sm font-medium">
                    SUCCESS
                </span>
                {% else %}
                <span class="bg-red-600/20 text-red-400 px-3 py-1 rounded-full text-sm font-medium">
                    FAILED
                </span>
                {% endif %}
            </div>
        </div>

        {% if view.error_message %}
        <div class="mt-4 bg-red-900/20 border border-red-700 rounded p-3">
            <p class="text-red-400 text-sm">{{ view.error_message }}</p>
        </div>
        {% endif %}
    </div>

    <!-- Action Buttons -->
    <div class="flex gap-3">
        <a href="/backtests/{{ view.run_id }}/export"
           download="backtest_report_{{ view.run_id }}.html"
           class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded text-white font-medium transition-colors">
            Export Report
        </a>

        <a href="/api/backtests/{{ view.id }}/export?format=csv"
           download="{{ view.strategy_name|replace(' ', '_') }}_{{ view.instrument_symbol }}_{{ view.start_date.strftime('%Y-%m-%d') }}_to_{{ view.end_date.strftime('%Y-%m-%d') }}_trades.csv"
           class="bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded text-white font-medium transition-colors">
            Export Trades (CSV)
        </a>
        <a href="/api/backtests/{{ view.id }}/export?format=json"
           download="{{ view.strategy_name|replace(' ', '_') }}_{{ view.instrument_symbol }}_{{ view.start_date.strftime('%Y-%m-%d') }}_to_{{ view.end_date.strftime('%Y-%m-%d') }}_trades.json"
           class="bg-teal-600 hover:bg-teal-700 px-4 py-2 rounded text-white font-medium transition-colors">
            Export Trades (JSON)
        </a>

        <button hx-delete="/backtests/{{ view.run_id }}"
                hx-confirm="Are you sure you want to delete this backtest? This action cannot be undone."
                hx-target="body"
                hx-push-url="/backtests"
                class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded text-white font-medium transition-colors">
            Delete
        </button>
        <button hx-post="/backtests/{{ view.run_id }}/rerun"
                hx-indicator="#rerun-spinner"
                hx-disabled-elt="this"
                class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-white font-medium transition-colors">
            <span>Re-run Backtest</span>
            <span id="rerun-spinner" class="htmx-indicator ml-2">
                <svg class="animate-spin h-4 w-4 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </span>
        </button>
    </div>

    {% if view.is_successful and view.metrics_panel %}
    <!-- Metrics Panel -->
    {% include "partials/metrics_panel.html" %}

    <!-- Trading Summary -->
    {% if view.trading_summary %}
    {% include "partials/trading_summary.html" %}
    {% endif %}

    <!-- Interactive Charts -->
    <div class="space-y-6">
        <!-- Price Chart with Indicators and Trade Markers -->
        <div class="bg-slate-900 rounded-lg border border-slate-700 p-6">
            <h2 class="text-lg font-semibold mb-4">Price Chart</h2>
            <div id="run-price-chart"
                 class="h-96 relative"
                 data-chart="run-price"
                 data-run-id="{{ view.run_id }}"
                 data-symbol="{{ view.configuration.instrument_symbol }}"
                 data-start="{{ view.configuration.start_date.strftime('%Y-%m-%d') }}"
                 data-end="{{ view.configuration.end_date.strftime('%Y-%m-%d') }}">
                <!-- Loading spinner -->
                <div class="chart-loading absolute inset-0 flex items-center justify-center bg-slate-900/80">
                    <div class="text-center">
                        <svg class="animate-spin h-8 w-8 mx-auto mb-2 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="text-slate-400 text-sm">Loading price data...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Equity Curve and Drawdown Chart -->
        <div class="bg-slate-900 rounded-lg border border-slate-700 p-6">
            <h2 class="text-lg font-semibold mb-4">Equity Curve</h2>
            <div id="run-equity-chart"
                 class="h-64 relative"
                 data-chart="run-equity"
                 data-run-id="{{ view.run_id }}"
                 data-backtest-id="{{ view.id }}">
                <!-- Loading spinner -->
                <div class="chart-loading absolute inset-0 flex items-center justify-center bg-slate-900/80">
                    <div class="text-center">
                        <svg class="animate-spin h-8 w-8 mx-auto mb-2 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="text-slate-400 text-sm">Loading equity data...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trade Statistics -->
        <div class="bg-slate-900 rounded-lg border border-slate-700 p-6">
            <h2 class="text-lg font-semibold mb-4">Trade Statistics</h2>
            <div id="trade-statistics"
                 class="relative"
                 data-backtest-id="{{ view.id }}">
                <!-- Content will be loaded via JavaScript -->
                <div class="stats-loading">
                    <div class="flex items-center justify-center py-8">
                        <div class="text-center">
                            <svg class="animate-spin h-8 w-8 mx-auto mb-2 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span class="text-slate-400 text-sm">Loading trade statistics...</span>
                        </div>
                    </div>
                </div>
                <div class="stats-content hidden"></div>
                <div class="stats-error hidden">
                    <div class="text-center py-8 text-red-400">
                        <p>Error loading trade statistics</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Drawdown Metrics -->
        <div class="bg-slate-900 rounded-lg border border-slate-700 p-6">
            <h2 class="text-lg font-semibold mb-4">Drawdown Analysis</h2>
            <div id="drawdown-metrics"
                 class="relative"
                 data-backtest-id="{{ view.id }}">
                <!-- Content will be loaded via JavaScript -->
                <div class="drawdown-loading">
                    <div class="flex items-center justify-center py-8">
                        <div class="text-center">
                            <svg class="animate-spin h-8 w-8 mx-auto mb-2 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span class="text-slate-400 text-sm">Loading drawdown metrics...</span>
                        </div>
                    </div>
                </div>
                <div class="drawdown-content hidden"></div>
                <div class="drawdown-error hidden">
                    <div class="text-center py-8 text-red-400">
                        <p>Error loading drawdown metrics</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Individual Trades -->
        <div class="bg-slate-900 rounded-lg border border-slate-700 p-6">
            <h2 class="text-lg font-semibold mb-4">Individual Trades</h2>
            <div id="trades-table-container"
                 class="relative"
                 data-backtest-id="{{ view.id }}">
                <!-- Content loaded via HTMX -->
                <div id="trades-table-content"
                     hx-get="/backtests/{{ view.id }}/trades-table?page=1&page_size=20&sort_by=entry_timestamp&sort_order=asc"
                     hx-trigger="load"
                     hx-swap="outerHTML">
                    <!-- Loading state -->
                    <div class="flex items-center justify-center py-12">
                        <div class="text-center">
                            <svg class="animate-spin h-8 w-8 mx-auto mb-2 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span class="text-slate-400 text-sm">Loading trades...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Configuration Snapshot -->
    {% include "partials/config_snapshot.html" %}
</div>

<!-- Toast Notifications Container -->
<div id="notifications" class="fixed top-4 right-4 z-50 space-y-2">
    <!-- Notifications will be inserted here -->
</div>
{% endblock %}
