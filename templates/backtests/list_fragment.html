<!-- Backtest List Table Fragment (HTMX partial) -->
{% if list_page.backtests|length == 0 %}
<!-- Empty Results Message -->
<div class="bg-slate-900 rounded-lg border border-slate-700 p-8 text-center">
    <h3 class="text-lg font-medium text-slate-200 mb-2">No Results Found</h3>
    <p class="text-slate-400">
        No backtests match your current filters. Try adjusting or clearing your filters.
    </p>
</div>
{% else %}
{# Build sort URL helper - preserves all current filters #}
{% set sort_base_params = [] %}
{% if list_page.filter_state.strategy %}
    {% set _ = sort_base_params.append("strategy=" ~ list_page.filter_state.strategy|urlencode) %}
{% endif %}
{% if list_page.filter_state.instrument %}
    {% set _ = sort_base_params.append("instrument=" ~ list_page.filter_state.instrument|urlencode) %}
{% endif %}
{% if list_page.filter_state.date_from %}
    {% set _ = sort_base_params.append("date_from=" ~ list_page.filter_state.date_from.isoformat()) %}
{% endif %}
{% if list_page.filter_state.date_to %}
    {% set _ = sort_base_params.append("date_to=" ~ list_page.filter_state.date_to.isoformat()) %}
{% endif %}
{% if list_page.filter_state.status %}
    {% set _ = sort_base_params.append("status=" ~ list_page.filter_state.status.value) %}
{% endif %}
{% set sort_base = sort_base_params|join("&") %}
{% if sort_base %}{% set sort_base = sort_base ~ "&" %}{% endif %}

{# Macro for sortable column header #}
{% macro sort_header(column_id, label, align="left") %}
{% set is_current = list_page.filter_state.sort.value == column_id %}
{% set next_order = "asc" if (is_current and list_page.filter_state.order.value == "desc") else "desc" %}
{% set indicator = "" %}
{% if is_current %}
    {% set indicator = "&#9660;" if list_page.filter_state.order.value == "desc" else "&#9650;" %}
{% endif %}
<th scope="col" class="px-6 py-3 text-{{ align }} text-xs font-medium text-slate-300 uppercase tracking-wider">
    <button
        type="button"
        hx-get="/backtests/fragment?{{ sort_base }}sort={{ column_id }}&order={{ next_order }}&page=1"
        hx-target="#backtest-table"
        hx-swap="innerHTML"
        class="flex items-center gap-1 hover:text-white transition-colors {% if align == 'right' %}ml-auto{% endif %}"
    >
        {{ label }}
        {% if indicator %}
        <span class="text-blue-400">{{ indicator|safe }}</span>
        {% endif %}
    </button>
</th>
{% endmacro %}

<div class="bg-slate-900 rounded-lg border border-slate-700 overflow-hidden">
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-slate-700">
            <thead class="bg-slate-800">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">
                        Run ID
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">
                        Strategy
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">
                        Symbol
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase tracking-wider">
                        Date Range
                    </th>
                    {{ sort_header("total_return", "Return", "right") }}
                    {{ sort_header("sharpe_ratio", "Sharpe", "right") }}
                    {{ sort_header("max_drawdown", "Max DD", "right") }}
                    <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-slate-300 uppercase tracking-wider">
                        Status
                    </th>
                    {{ sort_header("created_at", "Created", "left") }}
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-800">
                {% for item in list_page.backtests %}
                <tr class="table-row-alt table-row-hover cursor-pointer"
                    onclick="window.location='/backtests/{{ item.run_id }}'">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="font-mono text-sm text-slate-400">{{ item.run_id_short }}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="text-slate-200 font-medium" title="{{ item.strategy_name }}">
                            {% if item.strategy_name|length > 50 %}
                            {{ item.strategy_name[:47] }}...
                            {% else %}
                            {{ item.strategy_name }}
                            {% endif %}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="text-slate-300">{{ item.instrument_symbol }}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="text-sm text-slate-400">{{ item.date_range }}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">
                        {% if item.total_return is not none %}
                        <span class="{% if item.is_positive_return %}text-green-500{% else %}text-red-500{% endif %} font-medium">
                            {{ "%.2f%%"|format(item.return_percentage) }}
                        </span>
                        {% else %}
                        <span class="text-slate-500">N/A</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">
                        {% if item.sharpe_ratio is not none %}
                        <span class="text-slate-200">{{ "%.2f"|format(item.sharpe_ratio) }}</span>
                        {% else %}
                        <span class="text-slate-500">N/A</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">
                        {% if item.max_drawdown is not none %}
                        <span class="text-red-500">{{ "%.2f%%"|format(item.max_drawdown * 100) }}</span>
                        {% else %}
                        <span class="text-slate-500">N/A</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        {% if item.execution_status == "success" %}
                        <span class="px-2 py-1 text-xs font-medium rounded bg-green-900 text-green-300">
                            success
                        </span>
                        {% else %}
                        <span class="px-2 py-1 text-xs font-medium rounded bg-red-900 text-red-300">
                            failed
                        </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="text-sm text-slate-500">
                            {{ item.created_at.strftime("%Y-%m-%d %H:%M") }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination Controls -->
    {% if list_page.total_pages > 1 %}
    {% set base_params = [] %}
    {% if list_page.filter_state.strategy %}
        {% set _ = base_params.append("strategy=" ~ list_page.filter_state.strategy|urlencode) %}
    {% endif %}
    {% if list_page.filter_state.instrument %}
        {% set _ = base_params.append("instrument=" ~ list_page.filter_state.instrument|urlencode) %}
    {% endif %}
    {% if list_page.filter_state.date_from %}
        {% set _ = base_params.append("date_from=" ~ list_page.filter_state.date_from.isoformat()) %}
    {% endif %}
    {% if list_page.filter_state.date_to %}
        {% set _ = base_params.append("date_to=" ~ list_page.filter_state.date_to.isoformat()) %}
    {% endif %}
    {% if list_page.filter_state.status %}
        {% set _ = base_params.append("status=" ~ list_page.filter_state.status.value) %}
    {% endif %}
    {% set _ = base_params.append("sort=" ~ list_page.filter_state.sort.value) %}
    {% set _ = base_params.append("order=" ~ list_page.filter_state.order.value) %}
    {% set base_query = base_params|join("&") %}

    <div class="bg-slate-800 px-6 py-3 border-t border-slate-700 flex items-center justify-between">
        <div class="text-sm text-slate-400">
            Page {{ list_page.page }} of {{ list_page.total_pages }}
        </div>
        <div class="flex space-x-2">
            {% if list_page.has_previous %}
            <button
                hx-get="/backtests/fragment?{{ base_query }}&page={{ list_page.page - 1 }}"
                hx-target="#backtest-table"
                hx-swap="innerHTML"
                class="px-3 py-1 text-sm bg-slate-700 hover:bg-slate-600 text-slate-200 rounded transition-colors"
            >
                Previous
            </button>
            {% else %}
            <button
                disabled
                class="px-3 py-1 text-sm bg-slate-900 text-slate-600 rounded cursor-not-allowed"
            >
                Previous
            </button>
            {% endif %}

            {% if list_page.has_next %}
            <button
                hx-get="/backtests/fragment?{{ base_query }}&page={{ list_page.page + 1 }}"
                hx-target="#backtest-table"
                hx-swap="innerHTML"
                class="px-3 py-1 text-sm bg-slate-700 hover:bg-slate-600 text-slate-200 rounded transition-colors"
            >
                Next
            </button>
            {% else %}
            <button
                disabled
                class="px-3 py-1 text-sm bg-slate-900 text-slate-600 rounded cursor-not-allowed"
            >
                Next
            </button>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>
{% endif %}
